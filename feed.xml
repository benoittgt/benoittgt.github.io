<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="en">
	<title>Benoit Tigeot&#39;s blog</title>
	<subtitle>Ruby on Rails, PostgreSQL, and more.</subtitle>
	<link href="https://benoittgt.github.io/feed.xml" rel="self"/>
	<link href="https://benoittgt.github.io/"/>
	<updated>2025-07-28T00:00:00Z</updated>
	<id>https://benoittgt.github.io/</id>
	<author>
		<name>Benoit Tigeot</name>
		<email>&lt;firstname.lastname@gmail.com&gt;</email>
	</author>
	
	<entry>
		<title>Measuring SELECT ... FOR UPDATE Latency in PostgreSQL</title>
		<link href="https://benoittgt.github.io/blog/postgres_measuring_lock/"/>
		<updated>2025-07-28T00:00:00Z</updated>
		<id>https://benoittgt.github.io/blog/postgres_measuring_lock/</id>
		<content type="html">&lt;p&gt;At &lt;a href=&quot;https://www.lifen.fr/&quot;&gt;Lifen&lt;/a&gt;, we love digging into database performance issues. Recently, while monitoring one of our Rails applications using PgAnalyze and specific logging, we noticed something concerning: around &lt;strong&gt;13‚Äì16% of a basic but frequently run query&lt;/strong&gt; was taking more than 100ms to complete‚Ä¶ and sometimes up to 1500ms. The culprit? &lt;code&gt;SELECT ... FOR UPDATE&lt;/code&gt; queries that were experiencing intermittent slowdowns. The average time was normally 6ms.&lt;/p&gt;
&lt;h3 id=&quot;slow-lock-acquisition&quot; tabindex=&quot;-1&quot;&gt;Slow lock &lt;strong&gt;acquisition&lt;/strong&gt; ? &lt;a class=&quot;header-anchor&quot; href=&quot;https://benoittgt.github.io/blog/postgres_measuring_lock/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;SELECT ... FOR UPDATE&lt;/code&gt; &lt;a href=&quot;https://www.postgresql.org/docs/current/sql-select.html&quot;&gt;is used to acquire a lock&lt;/a&gt; on row during a transaction. We use it to prevent concurrent async tasks from modifying the same row. This can happen, for example, when consuming lots of events from a queue system with an ‚Äúat least once‚Äù delivery guarantee.&lt;/p&gt;
&lt;p&gt;The obvious question was: &lt;em&gt;Are these queries slow because they‚Äôre waiting to acquire locks, or because they‚Äôre taking a long time to find the actual rows?&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This distinction matters a lot. If it‚Äôs &lt;strong&gt;lock contention&lt;/strong&gt;, we need to optimize our locking strategy. If it‚Äôs &lt;strong&gt;row lookup performance&lt;/strong&gt;, we need better indexes or query optimizations.&lt;/p&gt;
&lt;p&gt;PostgreSQL&#39;s built-in &lt;code&gt;log_lock_waits&lt;/code&gt; parameter seemed like the natural solution, but it requires setting a low &lt;code&gt;deadlock_timeout&lt;/code&gt;, which makes it impractical for production environments. We needed a different approach.&lt;/p&gt;
&lt;p&gt;From the doc on &lt;code&gt;log_lock_waits&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Controls whether a log message is produced when a session waits longer than &lt;a href=&quot;https://www.postgresql.org/docs/17/runtime-config-locks.html#GUC-DEADLOCK-TIMEOUT&quot;&gt;&lt;strong&gt;deadlock_timeout&lt;/strong&gt;&lt;/a&gt; to acquire a lock.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;measuring&quot; tabindex=&quot;-1&quot;&gt;Measuring &lt;a class=&quot;header-anchor&quot; href=&quot;https://benoittgt.github.io/blog/postgres_measuring_lock/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;To distinguish between lock acquisition time and row lookup time, we replaced the &lt;code&gt;FOR UPDATE&lt;/code&gt; with a &lt;code&gt;pg_advisory_xact_lock&lt;/code&gt;, then monitored both parts of the query separately.&lt;/p&gt;
&lt;p&gt;The SQL transformation looked like this:&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;-- Original&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt; id &lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; steps &lt;span class=&quot;token keyword&quot;&gt;WHERE&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;123&lt;/span&gt;_456 &lt;span class=&quot;token keyword&quot;&gt;FOR&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;UPDATE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;-- this is sometime slow&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;in_progress&#39;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; steps &lt;span class=&quot;token keyword&quot;&gt;WHERE&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;123&lt;/span&gt;_456&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;COMMIT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;-- Temporary new version&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt; pg_advisory_xact_lock&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashtext&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;update step status&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hashtext&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;123456&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;UPDATE&lt;/span&gt; steps &lt;span class=&quot;token keyword&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;status&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;in_progress&#39;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;WHERE&lt;/span&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;123&lt;/span&gt;_456&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;COMMIT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And in the Rails app:&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token method-definition&quot;&gt;&lt;span class=&quot;token function&quot;&gt;process_with_xact_lock&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step_id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  start_time &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current
  hash_key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;step:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;token content&quot;&gt;step_id&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;hash&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;abs

  ActiveRecord&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;Base&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;transaction &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
    connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;execute&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;SELECT pg_advisory_xact_lock(&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;token content&quot;&gt;connection&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;quote&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hash_key&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;)&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    lock_duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; start_time

    query_start &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current
    step &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Step&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;find&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step_id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    query_duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;Time&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;current &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; query_start

    step&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;update&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&#39;in_progress&#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    log_timing&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lock_duration&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; query_duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; slow_operation&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lock_duration&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; query_duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# ...&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token method-definition&quot;&gt;&lt;span class=&quot;token function&quot;&gt;slow_operation&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lock_time&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; query_time&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lock_time &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; query_time&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# 100ms threshold&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token method-definition&quot;&gt;&lt;span class=&quot;token function&quot;&gt;log_timing&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lock_ms&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; query_ms&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  Rails&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;logger&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;warn&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Slow operation: id=&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;token content&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt; lock=&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;token content&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lock_ms&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;round&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;ms query=&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;token content&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query_ms&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;round&lt;/span&gt;&lt;span class=&quot;token delimiter punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;ms&quot;&lt;/span&gt;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token method-definition&quot;&gt;&lt;span class=&quot;token function&quot;&gt;connection&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ActiveRecord&lt;span class=&quot;token double-colon punctuation&quot;&gt;::&lt;/span&gt;Base&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;connection
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The code is not bulletproof, but we only used it for a short period to gather data. We knew the chance of lock issues was low, and it was acceptable for this part of the application.&lt;/p&gt;
&lt;h3 id=&quot;what-we-learned&quot; tabindex=&quot;-1&quot;&gt;&lt;strong&gt;What we learned&lt;/strong&gt; &lt;a class=&quot;header-anchor&quot; href=&quot;https://benoittgt.github.io/blog/postgres_measuring_lock/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The results were interesting: when we experienced slowdowns with &lt;code&gt;SELECT ... FOR UPDATE&lt;/code&gt;, we &lt;strong&gt;also&lt;/strong&gt; saw slowness with the new &lt;code&gt;pg_advisory_xact_lock&lt;/code&gt; version both on &lt;strong&gt;lock acquisition&lt;/strong&gt; and &lt;strong&gt;row lookup&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;So, &lt;strong&gt;latency is global&lt;/strong&gt;, not specific to one part of the mechanism. That means we needed to look into other database activity that could be causing this broader slowdown.&lt;/p&gt;
&lt;p&gt;In our case, it appeared related to heavy DML activity and &lt;a href=&quot;https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/wait-event.iowalwrite.html&quot;&gt;IO:WALWrite&lt;/a&gt;. To mitigate this, we‚Äôre now looking at reducing the number of INSERT and UPDATE queries by grouping them.&lt;/p&gt;
&lt;h3 id=&quot;key-takeaways&quot; tabindex=&quot;-1&quot;&gt;Key Takeaways &lt;a class=&quot;header-anchor&quot; href=&quot;https://benoittgt.github.io/blog/postgres_measuring_lock/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Separate concerns when debugging&lt;/strong&gt;: Don&#39;t assume slow &lt;code&gt;SELECT ... FOR UPDATE&lt;/code&gt; means lock contention. Measure lock acquisition and query execution independently.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Production-friendly monitoring&lt;/strong&gt;: This technique works in production without requiring changes to PostgreSQL configuration like &lt;code&gt;deadlock_timeout&lt;/code&gt;. We hope that it will be possible to let PostgreSQL report this by itself (see &lt;a href=&quot;https://www.postgresql.org/message-id/flat/b8b8502915e50f44deb111bc0b43a99e2733e117.camel%40cybertec.at&quot;&gt;discussion on pg-hackers&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;pg_advisory_xact_lock is a great tool for precise, manual locking.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If you‚Äôre experiencing similar issues with SELECT ... FOR UPDATE, first check your logs, database metrics, and DML activity. Then try this measurement approach, you might discover, like we did, that the real bottleneck is elsewhere.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;em&gt;Thanks to the PostgreSQL community on Slack for the debugging suggestions that led to this technique.&lt;/em&gt;&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>As Rails developers, why we are excited about PostgreSQL 17</title>
		<link href="https://benoittgt.github.io/blog/postgres_17_rails/"/>
		<updated>2024-09-19T00:00:00Z</updated>
		<id>https://benoittgt.github.io/blog/postgres_17_rails/</id>
		<content type="html">&lt;p&gt;At the time of writing this article, PostgreSQL 17 is nearly out. &lt;a href=&quot;https://www.postgresql.org/about/news/postgresql-17-rc1-released-2926/&quot;&gt;On September 5th, the first release candidate was published&lt;/a&gt;. The final release is expected on September 26th, but we can already explain why we‚Äôve been eagerly awaiting this release since 1 year.&lt;/p&gt;
&lt;p&gt;At &lt;a href=&quot;https://www.lifen.fr/&quot;&gt;Lifen&lt;/a&gt;, we‚Äôve loved Rails from the beginning. We have several Rails applications, each with different scopes and teams, all using PostgreSQL as the main database. Some of these applications handle a significant amount of traffic, and their databases need to be properly monitored. This is done by the infrastructure team and the developers themselves using PgAnalyze, Grafana and sometimes AWS console with &amp;quot;Performance Insight&amp;quot;.&lt;/p&gt;
&lt;p&gt;More than a year ago, we started monitoring the 95th and 99th percentile response times (p95, p99) on an endpoint that was experiencing timeouts. These p99 times were important because they involved a client with significantly more data. While investigating the queries in AppSignal, we quickly found that the issue was on the database side, as is often the case.&lt;/p&gt;
&lt;p&gt;The problematic query involved one table with over 40 GB of data, which was heavily distributed. The query in Rails looked like this:&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;Doc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;where&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&#39;draft&#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&#39;sent&#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;sender_reference&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Client/1&#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string-literal&quot;&gt;&lt;span class=&quot;token string&quot;&gt;&#39;Client/2&#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;order&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;sent_at&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:desc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;limit&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pretty simple, right?&lt;/p&gt;
&lt;p&gt;Due to the nature of ActiveRecord DSL, this is something you see often, but without fully understanding the limitations of the underlying database. And those limitations can be surprising.&lt;/p&gt;
&lt;p&gt;When fetching many documents, the query was very slow. We looked at the EXPLAIN plans and quickly identified the issue: &lt;strong&gt;not all indexes were being used.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;You see plan like this one&lt;/p&gt;
&lt;pre class=&quot;language-markdown&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-markdown&quot;&gt;  -&gt;  Index Scan using docs_sent_at_idx on public.docs  (cost=0.56..39748945.58 rows=29744 width=38) (actual time=116.924..218.784 rows=20 loops=1)
        Output: id, type, status, sender_reference, sent_at, created_at
        Filter: (((docs.status)::text = ANY (&#39;{draft,sent}&#39;::text[])) AND ((docs.sender_reference)::text = ANY (&#39;{Client/1,Client/2}&#39;::text[])))
        Rows Removed by Filter: 46354
        Buffers: shared hit=1421 read=45046&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Index is used but you still need to perform expensive filtering.&lt;/p&gt;
&lt;p&gt;After some exchanges with some great folks on the PostgreSQL Slack, it was mentioned that &lt;strong&gt;PostgreSQL is not optimized for queries with multiple IN or ANY query parameters&lt;/strong&gt;. This was a problem, as such queries are common in Rails applications and aren‚Äôt easily optimized using indexes in PostgreSQL. But then, something unexpected happened‚Ä¶&lt;/p&gt;
&lt;p&gt;I received a private message from &lt;a href=&quot;https://github.com/petergeoghegan&quot;&gt;Peter Geoghegan&lt;/a&gt;. He was working on a patch that could help solve my issue. I tested the first version, then a second, and the results were very impressive, with a 90% reduction in query time (from 110ms to 10ms for some data). Indexes were fully utilized.&lt;/p&gt;
&lt;p&gt;The patch is well explained &lt;a href=&quot;https://pganalyze.com/blog/5mins-postgres-17-faster-btree-index-scans&quot;&gt;in a blog post on PgAnalyze&lt;/a&gt; but the changelog entry speaks for itself: ‚ÄúAllow B-tree indexes to more efficiently find a set of values, such as those supplied by IN clauses using constants.‚Äù&lt;/p&gt;
&lt;p&gt;Many iterations were made on this patch. I provided feedback on the PostgreSQL hackers &lt;a href=&quot;https://www.postgresql.org/message-id/flat/CAHUgstCm94QCN3hrLgU9SkVxhLiuh2G_HsksffZwZWHhzJEreg%40mail.gmail.com#f3af55f2367f6477256fcea40ce586a8&quot;&gt;mailing list&lt;/a&gt;, explaining why I, as a developer, was interested in this patch, along with benchmarks and execution plan outputs. The patch was included in PostgreSQL 17 beta, and additional fixes were added.&lt;/p&gt;
&lt;p&gt;With RC1 and a basic Rails application, here‚Äôs the improvement we saw:
We inserted 100 million rows into a table with three columns. This was done via SQL, but it could have been done in Rails as well.&lt;/p&gt;
&lt;pre class=&quot;language-sql&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;INTO&lt;/span&gt;
  docs &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sender_reference&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sent_at&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; created_at&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; updated_at&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;{sent,draft,suspended}&#39;&lt;/span&gt;::&lt;span class=&quot;token keyword&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ceil&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;random&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&#39;{Custom,Client}&#39;&lt;/span&gt;::&lt;span class=&quot;token keyword&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;ceil&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;random&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;/&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; floor&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;random&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LOCALTIMESTAMP &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;2 years&#39;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; random&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;::timestamptz&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  LOCALTIMESTAMP&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  LOCALTIMESTAMP
&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; generate_series&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;_000_000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; g&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Those columns are indexed with a multicolumn index.&lt;/p&gt;
&lt;pre class=&quot;language-ruby&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-ruby&quot;&gt;add_index &lt;span class=&quot;token symbol&quot;&gt;:docs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token symbol&quot;&gt;:sender_reference&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:status&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:sent_at&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;algorithm&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token symbol&quot;&gt;:concurrently&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With PostgreSQL 16 on a Rails 7.2 app, after several queries and with a warm cache, the response time was:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Query executed in 8.45 seconds.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;With PostgreSQL 17, the result is ü•Å:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Query executed in 0.11 seconds.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The query can still be optimized to get closer to 10ms, but the most challenging part to optimize has already been addressed by the patch.&lt;/p&gt;
&lt;p&gt;With results like these, I highly encourage you to upgrade to PostgreSQL 17. There are many &lt;a href=&quot;https://www.postgresql.org/docs/17/release-17.html&quot;&gt;other improvements&lt;/a&gt; as well. I also recommend digging deeper into the database side of your application, as this is often the key to faster response times. I‚Äôve learned that developers are welcome to share their feedback on the PostgreSQL hackers‚Äô mailing list, providing benchmarks and feedback as end users.&lt;/p&gt;
&lt;p&gt;Thanks to Peter Geoghegan, Matthias van de Meent, Hubert Depesz, Ants Aasma, and the rest of the PostgreSQL community for their work over the past year.&lt;/p&gt;
&lt;p&gt;If you‚Äôd like to follow the benchmarks made since last year, there is a &lt;a href=&quot;https://gist.github.com/benoittgt/ab72dc4cfedea2a0c6a5ee809d16e04d&quot;&gt;gist&lt;/a&gt;. You can also find the Rails app used to test response times &lt;a href=&quot;https://github.com/benoittgt/thanks-peter&quot;&gt;on Github&lt;/a&gt;.&lt;/p&gt;
</content>
	</entry>
</feed>
