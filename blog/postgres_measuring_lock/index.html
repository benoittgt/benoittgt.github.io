<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Measuring SELECT ... FOR UPDATE Latency in PostgreSQL</title>
		<meta name="description" content="Are queries slow because they’re waiting to acquire locks, or because they’re taking a long time to find the actual rows?">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Benoit Tigeot&#39;s blog">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Benoit Tigeot&#39;s blog">
		
		<style>/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 70em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
	padding-bottom: 8rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Benoit Tigeot&#39;s blog</a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/about/">About Me</a></li>
					<li class="nav-item"><a href="/feed.xml">RSS</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			
<h1>Measuring SELECT ... FOR UPDATE Latency in PostgreSQL</h1>

<ul class="post-metadata">
	<li><time datetime="2025-07-28">28 July 2025</time></li>
	<li><a href="/tags/postgresql/" class="post-tag">PostgreSQL</a>, </li>
	<li><a href="/tags/performance/" class="post-tag">Performance</a>, </li>
	<li><a href="/tags/rails/" class="post-tag">Rails</a></li>
</ul>

<p>At <a href="https://www.lifen.fr/">Lifen</a>, we love digging into database performance issues. Recently, while monitoring one of our Rails applications using PgAnalyze and specific logging, we noticed something concerning: around <strong>13–16% of a basic but frequently run query</strong> was taking more than 100ms to complete… and sometimes up to 1500ms. The culprit? <code>SELECT ... FOR UPDATE</code> queries that were experiencing intermittent slowdowns. The average time was normally 6ms.</p>
<h3 id="slow-lock-acquisition" tabindex="-1">Slow lock <strong>acquisition</strong> ? <a class="header-anchor" href="#slow-lock-acquisition">#</a></h3>
<p><code>SELECT ... FOR UPDATE</code> <a href="https://www.postgresql.org/docs/current/sql-select.html">is used to acquire a lock</a> on row during a transaction. We use it to prevent concurrent async tasks from modifying the same row. This can happen, for example, when consuming lots of events from a queue system with an “at least once” delivery guarantee.</p>
<p>The obvious question was: <em>Are these queries slow because they’re waiting to acquire locks, or because they’re taking a long time to find the actual rows?</em></p>
<p>This distinction matters a lot. If it’s <strong>lock contention</strong>, we need to optimize our locking strategy. If it’s <strong>row lookup performance</strong>, we need better indexes or query optimizations.</p>
<p>PostgreSQL's built-in <code>log_lock_waits</code> parameter seemed like the natural solution, but it requires setting a low <code>deadlock_timeout</code>, which makes it impractical for production environments. We needed a different approach.</p>
<p>From the doc on <code>log_lock_waits</code></p>
<blockquote>
<p>Controls whether a log message is produced when a session waits longer than <a href="https://www.postgresql.org/docs/17/runtime-config-locks.html#GUC-DEADLOCK-TIMEOUT"><strong>deadlock_timeout</strong></a> to acquire a lock.</p>
</blockquote>
<h3 id="measuring" tabindex="-1">Measuring <a class="header-anchor" href="#measuring">#</a></h3>
<p>To distinguish between lock acquisition time and row lookup time, we replaced the <code>FOR UPDATE</code> with a <code>pg_advisory_xact_lock</code>, then monitored both parts of the query separately.</p>
<p>The SQL transformation looked like this:</p>
<pre class="language-sql" tabindex="0"><code class="language-sql"><span class="token comment">-- Original</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> steps <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">123</span>_456 <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment">-- this is sometime slow</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'in_progress'</span> <span class="token keyword">FROM</span> steps <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">123</span>_456<span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>

<span class="token comment">-- Temporary new version</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> pg_advisory_xact_lock<span class="token punctuation">(</span>hashtext<span class="token punctuation">(</span><span class="token string">'update step status'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hashtext<span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> steps <span class="token keyword">SET</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'in_progress'</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">123</span>_456<span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span></code></pre>
<p>And in the Rails app:</p>
<pre class="language-ruby" tabindex="0"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">process_with_xact_lock</span></span><span class="token punctuation">(</span>step_id<span class="token punctuation">)</span>
  start_time <span class="token operator">=</span> <span class="token builtin">Time</span><span class="token punctuation">.</span>current
  hash_key <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"step:</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">step_id</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>hash<span class="token punctuation">.</span>abs

  ActiveRecord<span class="token double-colon punctuation">::</span>Base<span class="token punctuation">.</span>transaction <span class="token keyword">do</span>
    connection<span class="token punctuation">.</span>select_all<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"SELECT pg_advisory_xact_lock(</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">connection<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>hash_key<span class="token punctuation">)</span></span><span class="token delimiter punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span>
    lock_duration <span class="token operator">=</span> <span class="token builtin">Time</span><span class="token punctuation">.</span>current <span class="token operator">-</span> start_time

    query_start <span class="token operator">=</span> <span class="token builtin">Time</span><span class="token punctuation">.</span>current
    step <span class="token operator">=</span> Step<span class="token punctuation">.</span>find<span class="token punctuation">(</span>step_id<span class="token punctuation">)</span>
    query_duration <span class="token operator">=</span> <span class="token builtin">Time</span><span class="token punctuation">.</span>current <span class="token operator">-</span> query_start

    step<span class="token punctuation">.</span>update<span class="token operator">!</span><span class="token punctuation">(</span><span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'in_progress'</span></span><span class="token punctuation">)</span>

    log_timing<span class="token punctuation">(</span>step_id<span class="token punctuation">,</span> lock_duration<span class="token punctuation">,</span> query_duration<span class="token punctuation">)</span> <span class="token keyword">if</span> slow_operation<span class="token operator">?</span><span class="token punctuation">(</span>lock_duration<span class="token punctuation">,</span> query_duration<span class="token punctuation">)</span>

    <span class="token comment"># ...</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">private</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">slow_operation</span></span><span class="token operator">?</span><span class="token punctuation">(</span>lock_time<span class="token punctuation">,</span> query_time<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>lock_time <span class="token operator">+</span> query_time<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.1</span> <span class="token comment"># 100ms threshold</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">log_timing</span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> lock_ms<span class="token punctuation">,</span> query_ms<span class="token punctuation">)</span>
  Rails<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>warn<span class="token punctuation">(</span>
    <span class="token string-literal"><span class="token string">"Slow operation: id=</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">id</span><span class="token delimiter punctuation">}</span></span><span class="token string"> lock=</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token punctuation">(</span>lock_ms<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>round</span><span class="token delimiter punctuation">}</span></span><span class="token string">ms query=</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content"><span class="token punctuation">(</span>query_ms<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>round</span><span class="token delimiter punctuation">}</span></span><span class="token string">ms"</span></span>
  <span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">connection</span></span> <span class="token operator">=</span> ActiveRecord<span class="token double-colon punctuation">::</span>Base<span class="token punctuation">.</span>connection
</code></pre>
<p>The code is not bulletproof, but we only used it for a short period to gather data. We knew the chance of lock issues was low, and it was acceptable for this part of the application.</p>
<h3 id="what-we-learned" tabindex="-1"><strong>What we learned</strong> <a class="header-anchor" href="#what-we-learned">#</a></h3>
<p>The results were interesting: when we experienced slowdowns with <code>SELECT ... FOR UPDATE</code>, we <strong>also</strong> saw slowness with the new <code>pg_advisory_xact_lock</code> version both on <strong>lock acquisition</strong> and <strong>row lookup</strong>.</p>
<p>So, <strong>latency is global</strong>, not specific to one part of the mechanism. That means we needed to look into other database activity that could be causing this broader slowdown.</p>
<p>In our case, it appeared related to heavy DML activity and <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/wait-event.iowalwrite.html">IO:WALWrite</a>. To mitigate this, we’re now looking at reducing the number of INSERT and UPDATE queries by grouping them.</p>
<h3 id="key-takeaways" tabindex="-1">Key Takeaways <a class="header-anchor" href="#key-takeaways">#</a></h3>
<ol>
<li><strong>Separate concerns when debugging</strong>: Don't assume slow <code>SELECT ... FOR UPDATE</code> means lock contention. Measure lock acquisition and query execution independently.</li>
<li><strong>Production-friendly monitoring</strong>: This technique works in production without requiring changes to PostgreSQL configuration like <code>deadlock_timeout</code>. We hope that it will be possible to let PostgreSQL report this by itself (see <a href="https://www.postgresql.org/message-id/flat/b8b8502915e50f44deb111bc0b43a99e2733e117.camel%40cybertec.at">discussion on pg-hackers</a>)</li>
<li>pg_advisory_xact_lock is a great tool for precise, manual locking.</li>
</ol>
<p>If you’re experiencing similar issues with SELECT ... FOR UPDATE, first check your logs, database metrics, and DML activity. Then try this measurement approach, you might discover, like we did, that the real bottleneck is elsewhere.</p>
<hr>
<p><em>Thanks to the PostgreSQL community on Slack for the debugging suggestions that led to this technique.</em></p>

<ul class="links-nextprev"><li>Previous: <a href="/blog/postgres_17_rails/">As Rails developers, why we are excited about PostgreSQL 17</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- This page `/blog/postgres_measuring_lock/` was built on 2025-07-28T22:13:55.801Z -->
	</body>
</html>
